<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>商品详情</title>
    <style>
        /* =========================================
           1. 变量与基础
           ========================================= */
        :root {
            --bg-body: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --accent: #4f46e5;
            
            /* 状态色 */
            --st-green: #10b981; 
            --st-yellow: #f59e0b; 
            --st-gray: #cbd5e1;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fff; color: var(--text-main);
            padding-bottom: 40px;
        }

        /* =========================================
           2. 顶部导航 (悬浮)
           ========================================= */
        .nav-float {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            padding: 12px 16px; pointer-events: none;
        }
        .btn-back {
            pointer-events: auto;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .btn-back:hover { transform: scale(1.05); background: #fff; }
        .btn-back:active { transform: scale(0.95); }

        /* =========================================
           3. 图片展示区 (修复巨大化问题)
           ========================================= */
        .hero-stage {
            width: 100%;
            background: #f8fafc;
            position: relative;
            /* [修复核心] 限制高度，防止电脑上占满全屏 */
            height: 50vh; 
            max-height: 500px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            cursor: zoom-in;
        }
        
        .hero-img {
            /* [修复核心] 使用 contain 确保图片完整显示 */
            width: 100%; height: 100%; 
            object-fit: contain; 
            transition: opacity 0.3s;
        }

        .zoom-hint {
            position: absolute; bottom: 12px; right: 12px;
            background: rgba(0,0,0,0.5); color: #fff;
            padding: 4px 10px; border-radius: 4px;
            font-size: 12px; pointer-events: none;
        }

        /* =========================================
           4. 信息内容区
           ========================================= */
        .content {
            padding: 24px 20px;
            max-width: 800px; margin: 0 auto;
        }

        .price-text {
            font-size: 26px; font-weight: 800; color: #ef4444;
            margin-bottom: 12px;
        }

        .title-text {
            font-size: 20px; font-weight: 700; line-height: 1.4;
            margin-bottom: 24px;
        }

        /* 属性面板 */
        .meta-panel {
            background: #f1f5f9; border-radius: 12px;
            padding: 16px; display: grid; 
            grid-template-columns: 1fr 1fr; gap: 16px;
            margin-bottom: 30px;
        }
        
        .meta-item { display: flex; flex-direction: column; }
        .meta-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        
        /* 库存显示优化 */
        .stock-display {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            color: #fff; font-weight: 600; font-size: 14px; align-self: flex-start;
        }

        .desc-box { margin-top: 20px; }
        .desc-label { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
        .desc-content { font-size: 15px; line-height: 1.7; color: var(--text-sub); white-space: pre-wrap; }

        /* =========================================
           5. 全屏灯箱 (PC+Mobile 双引擎)
           ========================================= */
        #lightbox {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 2000; display: none;
            flex-direction: column;
            /* 关键：允许鼠标事件 */
            touch-action: none; 
        }

        .lb-header {
            position: absolute; top: 0; right: 0; z-index: 2001;
            padding: 20px;
        }
        .close-icon {
            color: #fff; font-size: 40px; cursor: pointer; opacity: 0.8;
            user-select: none;
        }

        .lb-canvas {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            cursor: grab; /* PC端显示抓手 */
        }
        .lb-canvas:active { cursor: grabbing; }

        #zoom-target {
            max-width: 100%; max-height: 100%;
            transform-origin: center center;
            will-change: transform;
            user-select: none; -webkit-user-drag: none; /* 禁止原生拖拽 */
        }

    </style>
</head>
<body>

    <nav class="nav-float">
        <div class="btn-back" onclick="location.href='index.html'">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        </div>
    </nav>

    <div id="lightbox">
        <div class="lb-header"><div class="close-icon" onclick="v.close()">×</div></div>
        <div class="lb-canvas" id="gesture-area">
            <img id="zoom-target" src="" draggable="false">
        </div>
    </div>

    <main id="app">
        <div class="hero-stage" onclick="v.open()">
            <img id="main-img" class="hero-img" src="" alt="">
            <div class="zoom-hint">点击全屏 / 滚轮缩放</div>
        </div>

        <div class="content">
            <div class="price-text" id="t-price">...</div>
            <h1 class="title-text" id="t-name">正在加载...</h1>

            <div class="meta-panel">
                <div class="meta-item">
                    <span class="meta-label">分类</span>
                    <span style="font-weight:600;" id="t-cat">-</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">库存状态</span>
                    <div id="t-stock" class="stock-display">checking...</div>
                </div>
            </div>

            <div class="desc-box">
                <div class="desc-label">详细描述</div>
                <div class="desc-content" id="t-desc">暂无描述</div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // 1. 视图逻辑 (View Logic)
        // ==========================================
        const urlParams = new URLSearchParams(window.location.search);
        const pid = urlParams.get('id');

        async function init() {
            if(!pid) return location.href = 'index.html';
            
            try {
                const res = await fetch(`/api/products?id=${pid}&t=${Date.now()}`);
                const data = await res.json();
                const item = Array.isArray(data) ? data[0] : data;
                
                if(!item) throw new Error("404");
                
                render(item);
                v.initEngine(); // 启动交互引擎

            } catch(e) {
                alert("无法加载商品");
            }
        }

        function render(p) {
            // 文本与图片
            const img = (p.image_url||'').split(',')[0];
            document.getElementById('main-img').src = img || 'https://via.placeholder.com/600';
            document.getElementById('zoom-target').src = img || 'https://via.placeholder.com/600';
            
            document.getElementById('t-name').innerText = p.name;
            document.getElementById('t-price').innerText = p.price || "暂无报价";
            document.getElementById('t-cat').innerText = p.category || "通用";
            document.getElementById('t-desc').innerText = p.description || "暂无详细描述";

            // [需求] 颜色背景库存
            const s = parseInt(p.stock) || 0;
            const elStock = document.getElementById('t-stock');
            
            if (s === 0) {
                elStock.innerText = "售罄 (0)";
                elStock.style.background = "var(--st-gray)";
            } else if (s <= 2) {
                elStock.innerText = `库存紧张 (${s})`;
                elStock.style.background = "var(--st-yellow)";
            } else {
                elStock.innerText = `充足 (${s})`;
                elStock.style.background = "var(--st-green)";
            }
        }

        // ==========================================
        // 2. 交互引擎 (Mouse + Touch)
        // ==========================================
        const v = {
            scale: 1,
            x: 0, 
            y: 0,
            isDragging: false,
            lastX: 0, 
            lastY: 0,
            startDist: 0,

            open() { 
                document.getElementById('lightbox').style.display = 'flex'; 
                this.reset();
            },
            close() { 
                document.getElementById('lightbox').style.display = 'none'; 
            },
            reset() {
                this.scale = 1; this.x = 0; this.y = 0;
                this.update();
            },
            update() {
                const el = document.getElementById('zoom-target');
                el.style.transform = `translate(${this.x}px, ${this.y}px) scale(${this.scale})`;
            },

            initEngine() {
                const area = document.getElementById('gesture-area');

                // --- A. 鼠标滚轮缩放 (Desktop) ---
                area.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    // 滚轮向上(负值)是放大
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    this.scale = Math.min(Math.max(0.5, this.scale * delta), 5);
                    this.update();
                }, { passive: false });

                // --- B. 鼠标拖拽 (Desktop) ---
                area.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    this.lastX = e.clientX;
                    this.lastY = e.clientY;
                    area.style.cursor = 'grabbing';
                });
                window.addEventListener('mousemove', (e) => {
                    if (!this.isDragging) return;
                    e.preventDefault();
                    const dx = e.clientX - this.lastX;
                    const dy = e.clientY - this.lastY;
                    this.x += dx; 
                    this.y += dy;
                    this.lastX = e.clientX; 
                    this.lastY = e.clientY;
                    this.update();
                });
                window.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    area.style.cursor = 'grab';
                });

                // --- C. 触摸手势 (Mobile) ---
                area.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        this.startDist = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                    } else if (e.touches.length === 1) {
                        this.isDragging = true;
                        this.lastX = e.touches[0].pageX;
                        this.lastY = e.touches[0].pageY;
                    }
                });

                area.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 2) {
                        const dist = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        this.scale = Math.min(Math.max(1, this.scale * (dist / this.startDist)), 5);
                        this.startDist = dist;
                        this.update();
                    } else if (e.touches.length === 1 && this.isDragging) {
                        const dx = e.touches[0].pageX - this.lastX;
                        const dy = e.touches[0].pageY - this.lastY;
                        this.x += dx; this.y += dy;
                        this.lastX = e.touches[0].pageX;
                        this.lastY = e.touches[0].pageY;
                        this.update();
                    }
                }, { passive: false });

                area.addEventListener('touchend', () => {
                    this.isDragging = false;
                    if (this.scale < 1) this.reset(); // 自动回弹
                });
            }
        };

        window.onload = init;
    </script>
</body>
</html>