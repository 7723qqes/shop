<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>商品详情 - 自由文本版</title>
    <style>
        /* =========================================
           1. 全局样式变量
           ========================================= */
        :root {
            --c-primary: #4f46e5;
            --c-dark: #0f172a;
            --c-gray: #64748b;
            --c-light: #f8fafc;
            --c-white: #ffffff;
            --c-danger: #ef4444; /* 价格强调色 */

            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            
            --shadow-float: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* =========================================
           2. 基础复位
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            background: var(--c-white); color: var(--c-dark);
            padding-bottom: calc(40px + var(--safe-bottom));
            overflow-x: hidden;
        }

        /* =========================================
           3. 导航栏 (悬浮透明)
           ========================================= */
        .nav-float {
            position: fixed; top: 0; left: 0; right: 0;
            padding: calc(12px + var(--safe-top)) 16px 12px;
            z-index: 100; pointer-events: none;
            display: flex; justify-content: space-between;
        }

        .btn-circle {
            pointer-events: auto;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
            color: var(--c-dark);
        }
        .btn-circle:active { transform: scale(0.9); }

        /* =========================================
           4. 主图查看器 (Hero Viewer)
           ========================================= */
        .viewer-stage {
            width: 100%; aspect-ratio: 1 / 1;
            background: var(--c-light);
            position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        .viewer-img {
            width: 100%; height: 100%; object-fit: contain;
            transition: opacity 0.3s ease;
        }

        .hint-pill {
            position: absolute; bottom: 16px; right: 16px;
            background: rgba(0,0,0,0.6); color: #fff;
            padding: 4px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 600;
            backdrop-filter: blur(4px); pointer-events: none;
            display: flex; align-items: center; gap: 6px;
        }

        /* =========================================
           5. 内容详情卡片
           ========================================= */
        .detail-card {
            margin-top: -24px;
            background: var(--c-white);
            border-radius: 24px 24px 0 0;
            padding: 32px 24px;
            position: relative; z-index: 10;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.03);
            min-height: 50vh;
        }

        /* 价格区域 - 自由文本样式 */
        .price-row {
            margin-bottom: 16px;
            display: flex; align-items: center;
        }

        .price-text-lg {
            font-size: 28px; font-weight: 800;
            color: var(--c-danger);
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .product-title {
            font-size: 22px; font-weight: 700; line-height: 1.4;
            color: var(--c-dark); margin-bottom: 24px;
        }

        /* 属性网格 */
        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 16px; margin-bottom: 32px;
        }
        
        .info-box {
            background: var(--c-light); padding: 16px;
            border-radius: 12px; border: 1px solid rgba(0,0,0,0.03);
        }

        .label-sm {
            font-size: 11px; text-transform: uppercase; 
            color: #94a3b8; font-weight: 700; letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .value-md {
            font-size: 15px; font-weight: 600; color: var(--c-dark);
        }
        .text-green { color: #10b981; }

        .divider-line {
            height: 1px; background: #f1f5f9; margin: 24px 0;
        }

        .desc-area h3 {
            font-size: 15px; font-weight: 700; margin-bottom: 12px;
        }
        .desc-text {
            font-size: 16px; color: var(--c-gray); line-height: 1.8;
            white-space: pre-wrap; word-break: break-all;
        }

        /* =========================================
           6. 全屏灯箱 (Lightbox)
           ========================================= */
        #lightbox {
            position: fixed; inset: 0; background: #000;
            z-index: 2000; display: none;
            flex-direction: column; touch-action: none;
        }

        .lb-head {
            position: absolute; top: 0; right: 0;
            padding: calc(20px + var(--safe-top)) 20px;
            z-index: 2001;
        }
        
        .close-x { color: #fff; font-size: 32px; font-weight: 200; padding: 10px; opacity: 0.8; }

        .lb-canvas {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        #zoom-target {
            max-width: 100%; max-height: 100%;
            transform-origin: center center;
            will-change: transform;
        }

        /* =========================================
           7. 骨架屏 (Skeleton Loading)
           ========================================= */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%; animation: pulse 1.5s infinite; border-radius: 6px;
        }
        @keyframes pulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>

    <nav class="nav-float">
        <div class="btn-circle" onclick="goHome()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </div>
    </nav>

    <div id="lightbox">
        <div class="lb-head"><div class="close-x" onclick="toggleZoom(false)">✕</div></div>
        <div class="lb-canvas" id="gesture-zone">
            <img id="zoom-target" src="" draggable="false">
        </div>
    </div>

    <main id="app-view">
        <div class="viewer-stage" onclick="toggleZoom(true)">
            <img id="hero-img" class="viewer-img" src="" alt="商品图片">
            <div class="hint-pill">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                点击查看细节
            </div>
        </div>

        <div class="detail-card">
            <div class="price-row" id="price-mount">
                <div class="skeleton" style="width:140px; height:36px;"></div>
            </div>

            <h1 class="product-title" id="title-mount">
                <div class="skeleton" style="width:100%; height:28px; margin-bottom:8px;"></div>
                <div class="skeleton" style="width:60%; height:28px;"></div>
            </h1>

            <div class="info-grid" id="meta-mount">
                <div class="info-box skeleton" style="height:70px;"></div>
                <div class="info-box skeleton" style="height:70px;"></div>
            </div>

            <div class="divider-line"></div>

            <div class="desc-area">
                <h3>详细描述</h3>
                <div class="desc-text" id="desc-mount">
                    <div class="skeleton" style="width:100%; height:16px; margin-bottom:8px;"></div>
                    <div class="skeleton" style="width:90%; height:16px; margin-bottom:8px;"></div>
                    <div class="skeleton" style="width:95%; height:16px;"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 全局状态机
        const STATE = {
            id: new URLSearchParams(window.location.search).get('id'),
            scale: 1,
            posX: 0,
            posY: 0,
            isDragging: false
        };

        // 1. 初始化程序
        async function init() {
            if (!STATE.id) return goHome();

            try {
                // 请求数据 (加时间戳防缓存)
                const res = await fetch(`/api/products?id=${STATE.id}&_t=${Date.now()}`);
                const data = await res.json();
                
                // 容错处理：Supabase可能返回数组或对象
                const product = Array.isArray(data) ? data[0] : data;
                
                if (!product) throw new Error("Item Not Found");

                render(product);
                initTouchEngine(); // 启动手势引擎

            } catch (e) {
                console.error(e);
                document.getElementById('app-view').innerHTML = `
                    <div style="padding:100px 20px; text-align:center; color:#94a3b8;">
                        <h3>无法读取档案</h3>
                        <p style="margin-top:10px;">数据可能已被移除或网络中断</p>
                        <button onclick="location.reload()" style="margin-top:20px; padding:8px 20px; border:1px solid #ccc; background:#fff; border-radius:20px;">重试</button>
                    </div>`;
            }
        }

        // 2. 渲染程序 (自由文本模式)
        function render(p) {
            // 图片
            const img = (p.image_url || '').split(',')[0].trim();
            document.getElementById('hero-img').src = img || 'https://via.placeholder.com/600?text=No+Image';
            document.getElementById('zoom-target').src = img || 'https://via.placeholder.com/600?text=No+Image';

            // 标题与描述
            document.getElementById('title-mount').innerText = p.name;
            document.getElementById('desc-mount').innerText = p.description || "暂无描述信息";

            // [核心] 价格直接渲染，不加任何符号
            const priceHtml = p.price 
                ? `<div class="price-text-lg">${p.price}</div>` 
                : `<div class="price-text-lg" style="color:#94a3b8; font-size:20px;">暂无报价</div>`;
            document.getElementById('price-mount').innerHTML = priceHtml;

            // 属性网格
            document.getElementById('meta-mount').innerHTML = `
                <div class="info-box">
                    <div class="label-sm">分类目录</div>
                    <div class="value-md">${p.category || '未分类'}</div>
                </div>
                <div class="info-box">
                    <div class="label-sm">当前库存</div>
                    <div class="value-md text-green">${p.stock}</div>
                </div>
            `;
            
            document.title = `${p.name} - 详情`;
        }

        // 3. 路由与灯箱控制
        function goHome() {
            window.location.href = 'index.html';
        }

        function toggleZoom(show) {
            const lb = document.getElementById('lightbox');
            lb.style.display = show ? 'flex' : 'none';
            if (!show) resetTransform();
        }

        // 4. 物理级手势引擎 (Touch Engine)
        function initTouchEngine() {
            const zone = document.getElementById('gesture-zone');
            
            let startDist = 0;
            let lastX = 0, lastY = 0;

            zone.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    startDist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                } else if (e.touches.length === 1) {
                    lastX = e.touches[0].pageX;
                    lastY = e.touches[0].pageY;
                    STATE.isDragging = true;
                }
            }, { passive: false });

            zone.addEventListener('touchmove', (e) => {
                e.preventDefault();

                if (e.touches.length === 2) {
                    // 双指缩放
                    const currDist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const factor = currDist / startDist;
                    STATE.scale = Math.min(Math.max(1, STATE.scale * factor), 5); // 最大5倍
                    startDist = currDist;
                } else if (e.touches.length === 1 && STATE.isDragging && STATE.scale > 1) {
                    // 单指拖拽 (仅当放大时)
                    const dx = e.touches[0].pageX - lastX;
                    const dy = e.touches[0].pageY - lastY;
                    STATE.posX += dx;
                    STATE.posY += dy;
                    lastX = e.touches[0].pageX;
                    lastY = e.touches[0].pageY;
                }
                updateView();
            }, { passive: false });

            zone.addEventListener('touchend', (e) => {
                STATE.isDragging = false;
                if (e.touches.length < 2) startDist = 0;
                // 自动回弹
                if (STATE.scale < 1) resetTransform();
            });
        }

        function updateView() {
            const el = document.getElementById('zoom-target');
            el.style.transform = `translate(${STATE.posX}px, ${STATE.posY}px) scale(${STATE.scale})`;
        }

        function resetTransform() {
            STATE.scale = 1; STATE.posX = 0; STATE.posY = 0;
            const el = document.getElementById('zoom-target');
            el.style.transition = 'transform 0.3s var(--ease-spring)';
            updateView();
            setTimeout(() => el.style.transition = '', 300);
        }

        // 启动
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>