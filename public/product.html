<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>物品详情 - 档案管理系统</title>
    <style>
        /* =========================================
           1. 核心设计系统 (Design System)
           ========================================= */
        :root {
            --p-color: #4f46e5;
            --p-soft: #eef2ff;
            --danger: #ef4444;
            --success: #10b981;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --bg-body: #ffffff;
            --bg-alt: #f8fafc;
            --border: #f1f5f9;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            
            --ease-out: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* =========================================
           2. 基础布局复位
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-body); color: var(--text-main);
            line-height: 1.6; user-select: none;
        }

        /* =========================================
           3. 导航与交互组件
           ========================================= */
        .top-nav {
            position: fixed; top: calc(12px + var(--safe-top)); left: 16px;
            z-index: 1000; display: flex; gap: 12px;
        }

        .icon-btn {
            width: 42px; height: 42px; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.3);
            text-decoration: none; color: var(--text-main); transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); background: #fff; }

        /* =========================================
           4. 媒体预览系统 (带缩放功能)
           ========================================= */
        .media-stage {
            width: 100%; aspect-ratio: 1 / 1; background: var(--bg-alt);
            overflow: hidden; position: relative; display: flex;
            align-items: center; justify-content: center;
        }

        #hero-img {
            width: 100%; height: 100%; object-fit: contain;
            transition: opacity 0.4s ease;
        }

        /* 缩放提示层 */
        .zoom-hint {
            position: absolute; bottom: 16px; right: 16px;
            background: rgba(0,0,0,0.5); color: #fff; padding: 4px 12px;
            border-radius: 20px; font-size: 11px; font-weight: 600;
            backdrop-filter: blur(4px); pointer-events: none;
            display: flex; align-items: center; gap: 6px;
        }

        /* 全屏灯箱 (Lightbox) */
        #lightbox {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: none; flex-direction: column; touch-action: none;
        }

        .lb-header {
            padding: calc(20px + var(--safe-top)) 20px 20px;
            display: flex; justify-content: flex-end;
        }

        .close-lb { color: #fff; font-size: 32px; font-weight: 200; padding: 10px; }

        .lb-content {
            flex: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        #zoom-target {
            max-width: 100%; max-height: 100%; will-change: transform;
            transition: transform 0.1s var(--ease-out);
        }

        /* =========================================
           5. 详情内容排版
           ========================================= */
        .detail-container {
            padding: 30px 20px calc(50px + var(--safe-bottom));
            max-width: 700px; margin: 0 auto;
        }

        /* [单位修复版价格显示] */
        .price-section {
            display: flex; align-items: baseline; color: var(--danger);
            margin-bottom: 15px;
        }
        .currency { font-size: 20px; font-weight: 800; }
        .price-val { font-size: 36px; font-weight: 900; margin: 0 4px; letter-spacing: -1px; }
        .unit-ext { font-size: 18px; color: var(--text-sub); font-weight: 400; }

        .product-title {
            font-size: 24px; font-weight: 800; line-height: 1.3;
            color: var(--text-main); margin-bottom: 24px;
        }

        .meta-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .tag-pill {
            padding: 6px 14px; background: var(--bg-alt); border-radius: 8px;
            font-size: 13px; font-weight: 700; color: var(--text-sub);
        }
        .tag-stock { background: #ecfdf5; color: var(--success); }

        .section-divider {
            height: 1px; background: var(--border); margin: 30px 0;
        }

        .info-label {
            font-size: 12px; font-weight: 900; color: #cbd5e1;
            text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px;
            display: block;
        }

        .description-text {
            font-size: 16px; color: #475569; line-height: 1.8;
            white-space: pre-wrap; word-break: break-all;
        }

        /* =========================================
           6. 加载态骨架屏
           ========================================= */
        .skeleton-load {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%; animation: loading-move 1.5s infinite;
        }
        @keyframes loading-move { to { background-position: -200% 0; } }
    </style>
</head>
<body>

    <div class="top-nav">
        <a href="index.html" class="icon-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><path d="m15 18-6-6 6-6"/></svg>
        </a>
    </div>

    <div id="lightbox">
        <div class="lb-header">
            <div class="close-lb" onclick="toggleLightbox(false)">✕</div>
        </div>
        <div class="lb-content" id="lb-stage">
            <img id="zoom-target" src="" draggable="false">
        </div>
    </div>

    <main id="main-view">
        <div class="media-stage" onclick="toggleLightbox(true)">
            <img id="hero-img" src="" alt="商品图片">
            <div class="zoom-hint">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                点击放大细节
            </div>
        </div>

        <div class="detail-container">
            <div id="mount-price" class="price-section">
                <div class="skeleton-load" style="height:40px; width:120px; border-radius:8px;"></div>
            </div>

            <h1 id="mount-title" class="product-title">
                <div class="skeleton-load" style="height:30px; width:80%; border-radius:8px; margin-bottom:10px;"></div>
                <div class="skeleton-load" style="height:30px; width:50%; border-radius:8px;"></div>
            </h1>

            <div id="mount-tags" class="meta-tags"></div>

            <div class="section-divider"></div>

            <span class="info-label">物品详情描述</span>
            <div id="mount-desc" class="description-text">
                <div class="skeleton-load" style="height:18px; width:100%; border-radius:4px; margin-bottom:8px;"></div>
                <div class="skeleton-load" style="height:18px; width:90%; border-radius:4px; margin-bottom:8px;"></div>
                <div class="skeleton-load" style="height:18px; width:95%; border-radius:4px;"></div>
            </div>
        </div>
    </main>

    <script>
        /**
         * [全局常量与状态机]
         */
        const URL_PARAMS = new URLSearchParams(window.location.search);
        const PRODUCT_ID = URL_PARAMS.get('id');
        let zoomState = { scale: 1, translateX: 0, translateY: 0 };

        /**
         * 1. 核心初始化器
         */
        async function initProductPage() {
            if (!PRODUCT_ID) { window.location.replace('index.html'); return; }

            try {
                // 请求数据并增加随机数防止缓存
                const response = await fetch(`/api/products?id=${PRODUCT_ID}&_nocache=${Date.now()}`);
                const data = await response.json();
                
                const product = Array.isArray(data) ? data[0] : data;
                if (!product) throw new Error("NOT_FOUND");

                renderProductDetails(product);
                initTouchEngine();

            } catch (err) {
                console.error("DATA_FETCH_ERROR:", err);
                document.getElementById('main-view').innerHTML = `
                    <div style="padding:100px 20px; text-align:center; color:#94a3b8;">
                        <p>无法获取物品档案，可能已被移除</p>
                        <a href="index.html" style="color:var(--p-color); margin-top:10px; display:inline-block;">返回首页</a>
                    </div>`;
            }
        }

        /**
         * 2. 详情渲染逻辑 (深度适配单位逻辑)
         */
        function renderProductDetails(p) {
            // 解析图片数组
            const imgList = (p.image_url || "").split(',').map(s => s.trim());
            const mainImg = imgList[0];

            // 图像赋值
            document.getElementById('hero-img').src = mainImg;
            document.getElementById('zoom-target').src = mainImg;

            // 标题与描述
            document.getElementById('mount-title').innerText = p.name;
            document.getElementById('mount-desc').innerText = p.description || "暂无对此物品的详细说明档案。";

            // [单位判定逻辑] 严格过滤 NULL 和空值
            const unitValue = p.unit || p.Unit || "";
            const unitClean = unitValue.toString().trim();
            const unitHTML = (unitClean && unitClean.toUpperCase() !== "NULL") 
                             ? `<span class="unit-ext">/ ${unitClean}</span>` : "";

            // 价格区渲染
            document.getElementById('mount-price').innerHTML = `
                <span class="currency">${p.currency || '¥'}</span>
                <span class="price-val">${p.price}</span>
                ${unitHTML}
            `;

            // 标签区渲染
            document.getElementById('mount-tags').innerHTML = `
                <span class="tag-pill">${p.category || '通用分类'}</span>
                <span class="tag-pill tag-stock">实时库存：${p.stock}</span>
            `;

            // 更新页面标题
            document.title = `${p.name} - 详情档案`;
        }

        /**
         * 3. 交互控制：灯箱切换
         */
        function toggleLightbox(active) {
            const lb = document.getElementById('lightbox');
            lb.style.display = active ? 'flex' : 'none';
            if (!active) {
                // 重置缩放状态
                zoomState = { scale: 1, translateX: 0, translateY: 0 };
                updateTransform();
            }
        }

        /**
         * 4. 工业级手势缩放算法 (Touch Engine)
         */
        function initTouchEngine() {
            const stage = document.getElementById('lb-stage');
            const target = document.getElementById('zoom-target');
            
            let initialDist = 0;
            let lastX = 0, lastY = 0;

            stage.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    // 双指捏合开始
                    initialDist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                } else if (e.touches.length === 1) {
                    // 单指拖拽开始
                    lastX = e.touches[0].pageX;
                    lastY = e.touches[0].pageY;
                }
            }, { passive: false });

            stage.addEventListener('touchmove', (e) => {
                e.preventDefault();

                if (e.touches.length === 2) {
                    // 处理缩放
                    const currentDist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const zoomFactor = currentDist / initialDist;
                    zoomState.scale = Math.min(Math.max(1, zoomState.scale * zoomFactor), 4);
                    initialDist = currentDist;
                } else if (e.touches.length === 1 && zoomState.scale > 1) {
                    // 处理放大后的拖拽
                    const deltaX = e.touches[0].pageX - lastX;
                    const deltaY = e.touches[0].pageY - lastY;
                    zoomState.translateX += deltaX;
                    zoomState.translateY += deltaY;
                    lastX = e.touches[0].pageX;
                    lastY = e.touches[0].pageY;
                }
                updateTransform();
            }, { passive: false });
        }

        function updateTransform() {
            const target = document.getElementById('zoom-target');
            target.style.transform = `translate(${zoomState.translateX}px, ${zoomState.translateY}px) scale(${zoomState.scale})`;
        }

        // 页面入口
        window.addEventListener('DOMContentLoaded', initProductPage);
    </script>
</body>
</html>