<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品详情</title>
    <style>
        :root { --primary: #2563eb; --bg: #ffffff; --text: #1e293b; --sub: #64748b; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f8fafc; margin: 0; color: var(--text); }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.03); }
        
        /* 导航 */
        .back-nav { position: absolute; top: 20px; left: 20px; z-index: 100; }
        .back-btn { background: rgba(255,255,255,0.8); backdrop-filter: blur(8px); padding: 10px 20px; border-radius: 25px; text-decoration: none; color: #000; font-size: 14px; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* 轮播图 */
        .slider { width: 100%; aspect-ratio: 1/1; position: relative; overflow: hidden; background: #f1f5f9; }
        .slider-track { display: flex; height: 100%; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .slider-item { min-width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .slider-item img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }

        .error-state { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; }
        .error-state svg { width: 60px; height: 60px; margin-bottom: 10px; opacity: 0.3; }

        .dots { position: absolute; bottom: 15px; width: 100%; display: flex; justify-content: center; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 4px; background: rgba(0,0,0,0.1); transition: 0.3s; }
        .dot.active { background: var(--primary); width: 24px; }

        /* 内容 */
        .content { padding: 30px 20px; }
        .price { font-size: 2.6rem; font-weight: 900; color: #e11d48; margin-bottom: 8px; letter-spacing: -1px; }
        .title { font-size: 1.5rem; font-weight: 800; line-height: 1.3; margin: 0 0 25px 0; color: #0f172a; }
        .tag-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 35px; }
        .tag { padding: 8px 16px; background: #eff6ff; border-radius: 12px; font-weight: 700; color: var(--primary); font-size: 14px; }
        
        .desc-section { border-top: 1px solid #f1f5f9; padding-top: 25px; }
        .desc-label { font-size: 0.9rem; font-weight: 800; color: #94a3b8; margin-bottom: 15px; display: block; }
        .desc-text { font-size: 1.15rem; line-height: 1.8; color: #334155; white-space: pre-wrap; }

        /* 全屏查看 */
        #gallery { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; z-index: 2000; cursor: grab; }
        #galImg { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); max-width: 100%; }
        .gal-close { position: fixed; top: 20px; right: 20px; color: #fff; font-size: 40px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="gallery" onclick="closeGal()"><span class="gal-close">×</span><img id="galImg"></div>
    <div class="container">
        <nav class="back-nav"><a href="index.html" class="back-btn">⬅ 返回</a></nav>
        <div class="slider" id="slider">
            <div id="track" class="slider-track"></div>
            <div id="dots" class="dots"></div>
        </div>
        <div id="app" class="content">正在加载商品详情...</div>
    </div>

    <script>
        const pid = new URLSearchParams(location.search).get("id");
        let currentIdx = 0, imgs = [];

        const errSvg = `<div class="error-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg><span>无图片</span></div>`;

        function handleImgError(img) { img.parentElement.innerHTML = errSvg; }

        async function load() {
            const cached = localStorage.getItem('inventory_cache');
            if (cached) {
                const p = JSON.parse(cached).find(item => item.id == pid);
                if (p) renderProduct(p);
            }
            try {
                const res = await fetch(`/api/products?id=${pid}&t=${Date.now()}`);
                const data = await res.json();
                if(data[0]) renderProduct(data[0]);
            } catch(e) {}
        }

        function renderProduct(p) {
            imgs = (p.image_url || "").split(',').map(u => u.trim()).filter(Boolean);
            document.getElementById('track').innerHTML = (imgs.length ? imgs : [""]).map(url => `
                <div class="slider-item">
                    ${url ? `<img src="${url}" onerror="handleImgError(this)" onclick="openGal('${url}')">` : errSvg}
                </div>`).join('');
            
            document.getElementById('dots').innerHTML = imgs.length > 1 ? imgs.map((_, i) => `<div class="dot ${i===0?'active':''}" onclick="goToSlide(${i})"></div>`).join('') : '';
            
            const stock = Number(p.stock) || 0;
            let sStyle = "background:#ecfdf5; color:#10b981;", sLabel = `库存: ${stock}`;
            if (stock <= 2) { sStyle = "background:#fffbeb; color:#f59e0b;"; sLabel = `库存: 紧张 (${stock})`; }
            if (stock === 0) { sStyle = "background:#fef2f2; color:#e11d48;"; sLabel = `库存: 缺货`; }

            document.getElementById('app').innerHTML = `
                <div class="price">¥${p.price}</div>
                <h1 class="title">${p.name}</h1>
                <div class="tag-row">
                    <span class="tag">${p.category||'分类'}</span>
                    <span class="tag" style="${sStyle}">${sLabel}</span>
                </div>
                <div class="desc-section">
                    <span class="desc-label">详细说明</span>
                    <div class="desc-text">${p.description||"暂无描述"}</div>
                </div>`;
        }

        function goToSlide(idx) {
            currentIdx = idx;
            document.getElementById('track').style.transform = `translateX(-${idx * 100}%)`;
            document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === idx));
        }

        function openGal(url) { document.getElementById('galImg').src = url; document.getElementById('gallery').style.display = 'block'; }
        function closeGal() { document.getElementById('gallery').style.display = 'none'; }
        
        load();
    </script>
</body>
</html>