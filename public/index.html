<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>库存看板 - 终极版</title>
    <style>
        /* =========================================
           1. 核心系统变量
           ========================================= */
        :root {
            --primary: #4f46e5;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            
            /* 库存状态色 */
            --stock-ok: #10b981;  /* 绿色 - 充足 */
            --stock-warn: #f59e0b; /* 黄色 - 紧张 */
            --stock-out: #94a3b8; /* 灰色 - 售罄 */
            
            --nav-height: 60px;
            --cat-height: 50px;
        }

        /* =========================================
           2. 基础布局
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-body); color: var(--text-main);
            padding-top: calc(var(--nav-height) + var(--cat-height)); /* 为固定头部留空 */
            min-height: 100vh;
        }

        /* =========================================
           3. 顶部组合导航 (搜索 + 分类)
           ========================================= */
        .header-group {
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 1000; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        /* 搜索栏 */
        .search-bar {
            height: var(--nav-height);
            display: flex; align-items: center; justify-content: center;
            padding: 0 16px; border-bottom: 1px solid #e2e8f0;
        }
        .search-input-wrap {
            position: relative; width: 100%; max-width: 600px;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; pointer-events: none;
        }
        .search-input {
            width: 100%; height: 38px; padding-left: 36px; padding-right: 16px;
            border-radius: 20px; border: 1px solid #cbd5e1;
            background: #f8fafc; outline: none; transition: all 0.2s;
        }
        .search-input:focus {
            background: #fff; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* 分类栏 (横向滚动) */
        .category-bar {
            height: var(--cat-height);
            display: flex; align-items: center;
            overflow-x: auto; white-space: nowrap;
            padding: 0 16px; gap: 10px;
            scrollbar-width: none; /* Firefox */
        }
        .category-bar::-webkit-scrollbar { display: none; } /* Chrome */

        .cat-chip {
            padding: 6px 16px; border-radius: 20px;
            font-size: 13px; font-weight: 500;
            background: #f1f5f9; color: #64748b;
            cursor: pointer; transition: all 0.2s;
            user-select: none; border: 1px solid transparent;
        }
        .cat-chip.active {
            background: var(--primary); color: #fff;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        /* =========================================
           4. 商品网格
           ========================================= */
        .main-container {
            max-width: 1200px; margin: 0 auto;
            padding: 20px 16px;
        }

        .grid {
            display: grid; gap: 16px;
            grid-template-columns: repeat(2, 1fr); /* 默认双列 */
        }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); gap: 24px; } }

        /* 卡片设计 */
        .card {
            background: var(--bg-card);
            border-radius: 12px; overflow: hidden;
            border: 1px solid #e2e8f0;
            display: flex; flex-direction: column;
            text-decoration: none; color: inherit;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        .card-img-box {
            aspect-ratio: 1 / 1; background: #f8fafc;
            position: relative; overflow: hidden;
        }
        .card-img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.5s;
        }
        .card:hover .card-img { transform: scale(1.05); }

        .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }

        .card-price {
            color: #ef4444; font-size: 16px; font-weight: 700;
            margin-bottom: 6px; display: block;
        }

        .card-title {
            font-size: 14px; line-height: 1.4; color: var(--text-main);
            margin-bottom: 12px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; height: 40px;
        }

        .card-footer {
            margin-top: auto; padding-top: 10px;
            border-top: 1px dashed #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* 库存胶囊样式 */
        .stock-pill {
            font-size: 11px; padding: 2px 8px; border-radius: 4px;
            color: #fff; font-weight: 600;
        }
        /* 动态类名由JS控制 */
        .stock-high { background: var(--stock-ok); }
        .stock-low  { background: var(--stock-warn); }
        .stock-zero { background: var(--stock-out); }

        /* =========================================
           5. 悬浮工具按钮 (右下角)
           ========================================= */
        .fab-group {
            position: fixed; bottom: 30px; right: 20px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 900;
        }
        .fab-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #475569; border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }

        /* =========================================
           6. 辅助 UI
           ========================================= */
        .loading-mask {
            position: fixed; inset: 0; background: #fff; z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-hint {
            grid-column: 1 / -1; text-align: center; padding: 60px 0;
            color: #94a3b8;
        }
    </style>
</head>
<body>

    <div id="loader" class="loading-mask">
        <div class="spinner"></div>
        <div style="font-size:14px; color:#64748b;">正在同步仓库数据...</div>
    </div>

    <header class="header-group">
        <div class="search-bar">
            <div class="search-input-wrap">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="搜索名称、价格..." oninput="app.onSearch()">
            </div>
        </div>
        <div class="category-bar" id="cat-mount">
            </div>
    </header>

    <main class="main-container">
        <div id="grid-mount" class="grid"></div>
    </main>

    <div class="fab-group">
        <div class="fab-btn" onclick="window.scrollTo({top:0, behavior:'smooth'})">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
        </div>
        <div class="fab-btn" onclick="window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'})">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
    </div>

    <script>
        const app = {
            data: [],
            activeCat: '全部',

            async init() {
                try {
                    const res = await fetch(`/api/products?t=${Date.now()}`);
                    if(!res.ok) throw new Error("API Error");
                    this.data = await res.json();
                    
                    // 1. 渲染分类栏
                    this.renderCategories();
                    
                    // 2. 渲染主网格
                    this.renderGrid(this.data);
                    
                    // 3. 关闭Loading
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').remove(), 500);

                } catch (err) {
                    alert("加载失败，请刷新重试");
                }
            },

            // 自动提取分类并渲染
            renderCategories() {
                const cats = ['全部', ...new Set(this.data.map(i => i.category || '未分类'))];
                const html = cats.map(c => 
                    `<div class="cat-chip ${c === this.activeCat ? 'active' : ''}" 
                          onclick="app.filterCat('${c}')">${c}</div>`
                ).join('');
                document.getElementById('cat-mount').innerHTML = html;
            },

            // 分类筛选逻辑
            filterCat(cat) {
                this.activeCat = cat;
                this.renderCategories(); // 更新按钮高亮
                this.onSearch(); // 触发组合筛选
            },

            // 搜索+分类 组合筛选
            onSearch() {
                const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
                
                const filtered = this.data.filter(item => {
                    // 1. 分类匹配
                    const matchCat = this.activeCat === '全部' || (item.category || '未分类') === this.activeCat;
                    // 2. 关键字匹配
                    const matchKey = (item.name + item.price).toLowerCase().includes(keyword);
                    
                    return matchCat && matchKey;
                });

                this.renderGrid(filtered);
            },

            // 核心渲染
            renderGrid(list) {
                const mount = document.getElementById('grid-mount');
                
                if (list.length === 0) {
                    mount.innerHTML = '<div class="empty-hint">暂无符合条件的物品</div>';
                    return;
                }

                mount.innerHTML = list.map(item => {
                    const img = (item.image_url || '').split(',')[0] || 'https://via.placeholder.com/300';
                    const stock = parseInt(item.stock) || 0;
                    
                    // [需求实现] 库存颜色逻辑
                    let stockClass = '';
                    let stockText = `${stock} 件`;
                    
                    if (stock === 0) {
                        stockClass = 'stock-zero';
                        stockText = '售罄';
                    } else if (stock <= 2) {
                        stockClass = 'stock-low'; // 黄色
                    } else {
                        stockClass = 'stock-high'; // 绿色
                    }

                    return `
                    <a href="product.html?id=${item.id}" class="card">
                        <div class="card-img-box">
                            <img src="${img}" class="card-img" loading="lazy">
                        </div>
                        <div class="card-body">
                            <span class="card-price">${item.price || '暂无报价'}</span>
                            <div class="card-title">${item.name}</div>
                            <div class="card-footer">
                                <span style="font-size:12px; color:#94a3b8;">${item.category || '通用'}</span>
                                <span class="stock-pill ${stockClass}">${stockText}</span>
                            </div>
                        </div>
                    </a>`;
                }).join('');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>