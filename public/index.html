<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>我的智能商店 - 完整版</title>
    <style>
        /* --- 核心变量与基础重置 --- */
        :root { 
            --primary: #4f46e5; --accent: #818cf8; --bg: #f8fafc; 
            --card-bg: #ffffff; --danger: #ef4444; --safe: #22c55e; 
            --warn: #f59e0b; --text-main: #1e293b; --text-sub: #64748b;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg); color: var(--text-main); margin: 0; padding: 0;
            line-height: 1.5; min-height: 100vh;
        }

        /* --- 导航栏：毛玻璃特效 --- */
        .header { 
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); padding: 15px 15px 10px; 
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header-top { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .header h1 { 
            font-size: 1.4rem; margin: 0; font-weight: 800; 
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- 搜索系统 --- */
        .search-container { max-width: 600px; margin: 0 auto 12px; position: relative; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); pointer-events: none; }
        .search-input { 
            width: 100%; padding: 12px 15px 12px 45px; border: 2px solid transparent; 
            border-radius: 18px; background: #f1f5f9; font-size: 15px; outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-input:focus { background: #fff; border-color: var(--primary); box-shadow: var(--shadow-md); }
        .highlight { background: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 4px; font-weight: bold; }

        /* --- 分类系统 --- */
        .nav-cats { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0 10px; scrollbar-width: none; -ms-overflow-style: none; }
        .nav-cats::-webkit-scrollbar { display: none; }
        .cat-item { 
            padding: 10px 20px; border-radius: 14px; border: none; background: #fff; 
            color: var(--text-sub); font-size: 14px; font-weight: 600; white-space: nowrap; 
            cursor: pointer; transition: 0.3s; box-shadow: var(--shadow-sm);
        }
        .cat-item.active { background: var(--primary); color: #fff; transform: scale(1.05); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* --- 核心展示网格 --- */
        .main-container { max-width: 1200px; margin: 0 auto; padding: 10px 15px 100px; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        
        .card { 
            background: var(--card-bg); border-radius: 24px; overflow: hidden; text-decoration: none; 
            color: inherit; display: flex; flex-direction: column; position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: var(--shadow-sm); border: 1px solid rgba(255,255,255,0.8);
        }
        .card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        .img-wrapper { width: 100%; aspect-ratio: 1/1; background: #f8fafc; overflow: hidden; position: relative; }
        .img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s ease; }
        .card:hover .img-wrapper img { transform: scale(1.1); }
        
        /* 售罄遮罩 */
        .sold-out { 
            position: absolute; inset: 0; background: rgba(255,255,255,0.6); 
            display: flex; align-items: center; justify-content: center; 
            backdrop-filter: blur(2px); z-index: 10; font-weight: 900; color: var(--danger);
            font-size: 1.2rem; transform: rotate(-15deg); border: 3px solid var(--danger);
            margin: auto; width: 80px; height: 40px; border-radius: 8px;
        }

        .info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .price-row { display: flex; align-items: baseline; color: var(--danger); margin-bottom: 8px; }
        .currency { font-size: 0.9rem; font-weight: 800; }
        .amount { font-size: 1.4rem; font-weight: 900; letter-spacing: -0.5px; }
        .unit-tag { font-size: 0.8rem; color: var(--text-sub); font-weight: 400; margin-left: 4px; }

        .title { 
            font-size: 0.95rem; font-weight: 700; line-height: 1.4; height: 2.8em; 
            overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; margin-bottom: 12px; color: var(--text-main);
        }
        
        .meta-bottom { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: auto; padding-top: 10px; border-top: 1px solid #f1f5f9;
        }
        .cat-name { font-size: 11px; color: var(--text-sub); background: #f1f5f9; padding: 2px 8px; border-radius: 6px; }
        .stock-status { padding: 4px 10px; border-radius: 10px; color: #fff; font-size: 11px; font-weight: 800; }
        
        /* --- 浮动控制面板 --- */
        .actions { position: fixed; right: 20px; bottom: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 2000; }
        .btn-float { 
            width: 50px; height: 50px; background: #fff; border-radius: 18px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.15); display: flex; align-items: center; 
            justify-content: center; cursor: pointer; border: none; transition: 0.3s;
        }
        .btn-float:active { transform: scale(0.9); }
        .btn-float svg { width: 24px; height: 24px; fill: var(--text-main); }
        #toTop { display: none; }

        /* --- 加载状态动画 --- */
        .loading-overlay { 
            position: fixed; inset: 0; background: var(--bg); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (min-width: 768px) { 
            .grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:var(--text-sub); font-size:14px; font-weight:bold;">同步云端数据...</p>
    </div>

    <div class="header">
        <div class="header-top"><h1>仓库管理系统 V3.1</h1></div>
        <div class="search-container">
            <span class="search-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </span>
            <input type="text" id="searchInput" class="search-input" placeholder="输入名称或条码搜索..." oninput="updateUI()">
        </div>
        <div id="catBar" class="nav-cats"></div>
    </div>

    <div class="main-container">
        <div id="productGrid" class="grid"></div>
    </div>

    <div class="actions">
        <button id="toTop" class="btn-float" onclick="window.scrollTo({top:0, behavior:'smooth'})">
            <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
        </button>
        <button class="btn-float" onclick="window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'})">
            <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
        </button>
    </div>

    <script>
        let products = [];
        let activeCat = '全部';

        // 页面初始化
        async function init() {
            // 1. 立即加载缓存以防白屏
            const cache = localStorage.getItem('full_shop_data');
            if (cache) {
                products = JSON.parse(cache);
                renderCats();
                updateUI();
                hideLoading(); // 如果有缓存，快速进入
            }

            // 2. 获取最新数据
            await fetchData();

            // 3. 滚动监听
            window.addEventListener('scroll', () => {
                document.getElementById('toTop').style.display = window.scrollY > 500 ? 'flex' : 'none';
            });
        }

        async function fetchData() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

            try {
                const res = await fetch(`/api/products?t=${Date.now()}`, { signal: controller.signal });
                if (!res.ok) throw new Error("HTTP Error");
                products = await res.json();
                
                // 更新缓存
                localStorage.setItem('full_shop_data', JSON.stringify(products));
                
                renderCats();
                updateUI();
            } catch (err) {
                console.error("Fetch failed:", err);
            } finally {
                clearTimeout(timeoutId);
                hideLoading(); // 无论如何，最后一定要关闭加载状态
            }
        }

        function hideLoading() {
            const loader = document.getElementById('loading');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            }
        }

        function renderCats() {
            const counts = products.reduce((acc, p) => {
                const c = p.category || '未分类';
                acc[c] = (acc[c] || 0) + 1;
                return acc;
            }, {});
            
            const cats = ['全部', ...Object.keys(counts)];
            const container = document.getElementById('catBar');
            container.innerHTML = cats.map(c => {
                const num = c === '全部' ? products.length : counts[c];
                return `<button class="cat-item ${activeCat === c ? 'active' : ''}" onclick="switchCat('${c}')">${c} <span>${num}</span></button>`;
            }).join('');
        }

        function switchCat(c) {
            activeCat = c;
            renderCats();
            updateUI();
        }

        function updateUI() {
            const kw = document.getElementById('searchInput').value.trim().toLowerCase();
            const grid = document.getElementById('productGrid');
            
            let filtered = products.filter(p => {
                const matchCat = activeCat === '全部' || (p.category || '未分类') === activeCat;
                const matchKw = p.name.toLowerCase().includes(kw);
                return matchCat && matchKw;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; padding:50px; text-align:center; color:var(--text-sub);">没有找到相关物品</div>`;
                return;
            }

            grid.innerHTML = filtered.map(p => {
                const stockNum = Number(p.stock) || 0;
                let sCol = 'var(--safe)';
                if (stockNum === 0) sCol = 'var(--danger)';
                else if (stockNum <= 2) sCol = 'var(--warn)';

                const currency = p.currency || '¥';
                const unitText = p.unit ? `<span class="unit-tag">/ ${p.unit}</span>` : '';
                const imgUrl = (p.image_url || "").split(',')[0].trim();
                
                // 搜索高亮逻辑
                const displayName = kw ? p.name.replace(new RegExp(kw, 'gi'), m => `<span class="highlight">${m}</span>`) : p.name;

                return `
                <a href="product.html?id=${p.id}" class="card">
                    <div class="img-wrapper">
                        ${stockNum === 0 ? '<div class="sold-out">SOLD OUT</div>' : ''}
                        <img src="${imgUrl}" loading="lazy" onerror="this.src='https://via.placeholder.com/400x400?text=暂无图片'">
                    </div>
                    <div class="info">
                        <div class="price-row">
                            <span class="currency">${currency}</span>
                            <span class="amount">${p.price}</span>
                            ${unitText}
                        </div>
                        <div class="title">${displayName}</div>
                        <div class="meta-bottom">
                            <span class="cat-name">${p.category || '未分类'}</span>
                            <span class="stock-status" style="background:${sCol}">库存: ${stockNum}</span>
                        </div>
                    </div>
                </a>`;
            }).join('');
        }

        // 启动
        init();
    </script>
</body>
</html>